---
import Heading from "./ui/Heading.astro";
import { getCollection, type CollectionEntry } from "astro:content";

type ExperienceEntry = CollectionEntry<"experience">;
type WorkExperience = ExperienceEntry & {
  data: Extract<ExperienceEntry["data"], { type: "work" }>;
};
type EducationExperience = ExperienceEntry & {
  data: Extract<ExperienceEntry["data"], { type: "education" }>;
};

const isWorkExperience = (entry: ExperienceEntry): entry is WorkExperience =>
  entry.data.type === "work";
const isEducationExperience = (
  entry: ExperienceEntry,
): entry is EducationExperience => entry.data.type === "education";

const experience = await getCollection("experience");
const workExperience = experience.filter(isWorkExperience);
const educationExperience = experience.filter(isEducationExperience);

const formatDate = (date: Date | null | undefined) => {
  if (!date) return "Present";
  return date.toLocaleDateString("en-US", { month: "short", year: "numeric" });
};

const getLatestStart = (exp: WorkExperience) => {
  if (exp.data.periods && exp.data.periods.length > 0) {
    const dates = exp.data.periods.map((p) => p.start?.getTime() ?? 0);
    return Math.max(...dates);
  }
  return exp.data.start?.getTime() ?? 0;
};
---

<>
  <section aria-labelledby="Work experience" class="w-full">
    <Heading tag="h3" size="h3" icon="work">Work Experience</Heading>
    <div class="mt-6 space-y-4">
      {
        workExperience
          .sort((a, b) => getLatestStart(b) - getLatestStart(a))
          .map((exp) => (
            <article class="group relative rounded-xl border border-(--color-base-300) bg-(--color-base-200)/50 p-6 transition-all hover:border-(--color-secondary)/50 hover:bg-(--color-base-200)">
              <div class="flex flex-col gap-1 sm:flex-row sm:items-start sm:justify-between">
                <div>
                  <h4 class="text-lg font-semibold text-(--color-base-content)">
                    {exp.data.company}
                  </h4>
                  {exp.data.role && (
                    <p class="text-(--color-accent)">{exp.data.role}</p>
                  )}
                </div>
                <span class="text-sm text-(--color-muted) sm:text-right">
                  {exp.data.location}
                </span>
              </div>

              <div class="mt-3 flex flex-wrap gap-x-4 gap-y-1 text-sm text-(--color-muted)">
                {exp.data.periods && exp.data.periods.length > 0 ? (
                  exp.data.periods.map((period, idx) => (
                    <span class="inline-flex items-center gap-1">
                      <span class="inline-block h-1.5 w-1.5 rounded-full bg-(--color-secondary)" />
                      {formatDate(period.start)} — {formatDate(period.end)}
                    </span>
                  ))
                ) : (
                  <span class="inline-flex items-center gap-1">
                    <span class="inline-block h-1.5 w-1.5 rounded-full bg-(--color-secondary)" />
                    {formatDate(exp.data.start)} — {formatDate(exp.data.end)}
                  </span>
                )}
              </div>

              {(exp.data.tech?.length || exp.data.skills?.length) && (
                <div class="mt-4 flex flex-wrap gap-2">
                  {exp.data.tech?.map((tech) => (
                    <span class="rounded-full border border-(--color-secondary)/30 bg-(--color-primary) px-3 py-1 text-xs text-(--color-base-content)">
                      {tech}
                    </span>
                  ))}
                  {exp.data.skills?.map((skill) => (
                    <span class="rounded-full border border-(--color-secondary)/30 bg-(--color-primary) px-3 py-1 text-xs text-(--color-base-content)">
                      {skill}
                    </span>
                  ))}
                </div>
              )}
            </article>
          ))
      }
    </div>
  </section>

  <section aria-labelledby="Education" class="w-full">
    <Heading tag="h3" size="h3" icon="school"> Education </Heading>
    <div class="mt-6 space-y-4">
      {
        educationExperience
          .sort((a, b) => b.data.start.getTime() - a.data.start.getTime())
          .map((exp) => (
            <article class="group relative rounded-xl border border-(--color-base-300) bg-(--color-base-200)/50 p-6 transition-all hover:border-(--color-secondary)/50 hover:bg-(--color-base-200)">
              <div class="flex flex-col gap-1 sm:flex-row sm:items-start sm:justify-between">
                <div>
                  <h4 class="text-lg font-semibold text-(--color-base-content)">
                    {exp.data.institution}
                  </h4>
                  <p class="text-(--color-accent)">{exp.data.program}</p>
                  <p class="text-sm text-(--color-muted)">{exp.data.level}</p>
                </div>
              </div>

              <div class="mt-3 flex flex-wrap gap-x-4 gap-y-1 text-sm text-(--color-muted)">
                <span class="inline-flex items-center gap-1">
                  <span class="inline-block h-1.5 w-1.5 rounded-full bg-(--color-secondary)" />
                  {formatDate(exp.data.start)} — {formatDate(exp.data.end)}
                </span>
              </div>

              {exp.data.focus && exp.data.focus.length > 0 && (
                <div class="mt-4 flex flex-wrap gap-2">
                  {exp.data.focus.map((item) => (
                    <span class="rounded-full bg-(--color-primary) px-3 py-1 text-xs text-(--color-base-content)">
                      {item}
                    </span>
                  ))}
                </div>
              )}
            </article>
          ))
      }
    </div>
  </section>
</>
