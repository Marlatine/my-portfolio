---
import Heading from "./ui/Heading.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import { formatDate } from "@/lib/date/formatDate";

type ExperienceEntry = CollectionEntry<"experience">;
type WorkExperience = ExperienceEntry & {
  data: Extract<ExperienceEntry["data"], { type: "work" }>;
};
type EducationExperience = ExperienceEntry & {
  data: Extract<ExperienceEntry["data"], { type: "education" }>;
};

const isWorkExperience = (entry: ExperienceEntry): entry is WorkExperience =>
  entry.data.type === "work";
const isEducationExperience = (
  entry: ExperienceEntry
): entry is EducationExperience => entry.data.type === "education";

const experience = await getCollection("experience");
const workExperience = experience.filter(isWorkExperience);
const educationExperience = experience.filter(isEducationExperience);

const getLatestStart = (exp: WorkExperience) => {
  if (exp.data.periods && exp.data.periods.length > 0) {
    const dates = exp.data.periods.map((p) => p.start?.getTime() ?? 0);
    return Math.max(...dates);
  }
  return exp.data.start?.getTime() ?? 0;
};
---

<>
  <section aria-labelledby="Work experience" class="w-full">
    <div class="reveal-heading">
      <Heading tag="h3" size="h3" icon="work" iconSize={32}
        >Work Experience</Heading
      >
    </div>
    <div class="mt-6 space-y-4">
      {
        workExperience
          .sort((a, b) => getLatestStart(b) - getLatestStart(a))
          .map((exp, i) => (
            <article
              class="reveal-card group relative rounded-xl border border-(--color-base-200) bg-(--color-base-200) p-6 transition-all hover:border-(--color-secondary) hover:bg-(--color-base-300)"
              style={`--reveal-delay: ${i * 120}ms`}
            >
              <div class="flex flex-col gap-1 sm:flex-row sm:items-start sm:justify-between">
                <div>
                  <h4 class="text-lg font-semibold text-(--color-base-content)">
                    {exp.data.company}
                  </h4>
                  {exp.data.role && (
                    <p class="text-(--color-accent)">{exp.data.role}</p>
                  )}
                </div>
                <span class="text-sm text-(--color-muted) sm:text-right">
                  {exp.data.location}
                </span>
              </div>

              <div class="mt-3 flex flex-wrap gap-x-4 gap-y-1 text-sm text-(--color-muted)">
                {exp.data.periods && exp.data.periods.length > 0 ? (
                  exp.data.periods.map((period, idx) => (
                    <span class="inline-flex items-center gap-1">
                      <span class="inline-block h-1.5 w-1.5 rounded-full bg-(--color-secondary)" />
                      {formatDate(period.start)} — {formatDate(period.end)}
                    </span>
                  ))
                ) : (
                  <span class="inline-flex items-center gap-1">
                    <span class="inline-block h-1.5 w-1.5 rounded-full bg-(--color-secondary)" />
                    {formatDate(exp.data.start)} — {formatDate(exp.data.end)}
                  </span>
                )}
              </div>

              {(exp.data.tech?.length || exp.data.skills?.length) && (
                <div class="mt-4 flex flex-wrap gap-2">
                  {exp.data.tech?.map((tech) => (
                    <span class="rounded-full border border-(--color-secondary) bg-(--color-primary) px-3 py-1 text-xs text-(--color-base-content)">
                      {tech}
                    </span>
                  ))}
                  {exp.data.skills?.map((skill) => (
                    <span class="rounded-full border border-(--color-secondary) bg-(--color-primary) px-3 py-1 text-xs text-(--color-base-content)">
                      {skill}
                    </span>
                  ))}
                </div>
              )}
            </article>
          ))
      }
    </div>
  </section>

  <section aria-labelledby="Education" class="w-full">
    <div class="reveal-heading">
      <Heading tag="h3" size="h3" icon="school" iconSize={32}>
        Education
      </Heading>
    </div>
    <div class="mt-6 space-y-4">
      {
        educationExperience
          .sort((a, b) => b.data.start.getTime() - a.data.start.getTime())
          .map((exp, i) => (
            <article
              class="reveal-card group relative rounded-xl border border-(--color-base-200) bg-(--color-base-200) p-6 transition-all hover:border-(--color-secondary) hover:bg-(--color-base-300)"
              style={`--reveal-delay: ${i * 120}ms`}
            >
              <div class="flex flex-col gap-1 sm:flex-row sm:items-start sm:justify-between">
                <div>
                  <h4 class="text-lg font-semibold text-(--color-base-content)">
                    {exp.data.institution}
                  </h4>
                  <p class="text-(--color-accent)">{exp.data.program}</p>
                  <p class="text-sm text-(--color-muted)">{exp.data.level}</p>
                </div>
                <span class="text-sm text-(--color-muted) sm:text-right">
                  {exp.data.location}
                </span>
              </div>

              <div class="mt-3 flex flex-wrap gap-x-4 gap-y-1 text-sm text-(--color-muted)">
                <span class="inline-flex items-center gap-1">
                  <span class="inline-block h-1.5 w-1.5 rounded-full bg-(--color-secondary)" />
                  {formatDate(exp.data.start)} — {formatDate(exp.data.end)}
                </span>
              </div>

              {exp.data.focus && exp.data.focus.length > 0 && (
                <div class="mt-4 flex flex-wrap gap-2">
                  {exp.data.focus.map((item) => (
                    <span class="rounded-full bg-(--color-primary) px-3 py-1 text-xs text-(--color-base-content)">
                      {item}
                    </span>
                  ))}
                </div>
              )}
            </article>
          ))
      }
    </div>
  </section>
</>

<style>
  /* ===== Section heading reveal ===== */
  .reveal-heading {
    opacity: 0;
    transform: translateY(20px);
    filter: blur(4px);
    transition:
      opacity 0.6s cubic-bezier(0.16, 1, 0.3, 1),
      transform 0.6s cubic-bezier(0.16, 1, 0.3, 1),
      filter 0.6s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .reveal-heading.is-visible {
    opacity: 1;
    transform: translateY(0);
    filter: blur(0);
  }

  /* ===== Card reveal ===== */
  .reveal-card {
    opacity: 0;
    transform: translateY(24px);
    filter: blur(4px);
    transition:
      opacity 0.65s cubic-bezier(0.16, 1, 0.3, 1),
      transform 0.65s cubic-bezier(0.16, 1, 0.3, 1),
      filter 0.65s cubic-bezier(0.16, 1, 0.3, 1),
      border-color 0.2s ease,
      background-color 0.2s ease;
    transition-delay: var(--reveal-delay, 0ms);
  }

  .reveal-card.is-visible {
    opacity: 1;
    transform: translateY(0);
    filter: blur(0);
  }

  /* ===== Reduced motion ===== */
  @media (prefers-reduced-motion: reduce) {
    .reveal-heading,
    .reveal-card {
      opacity: 1;
      transform: none;
      filter: none;
      transition: none;
    }
  }
</style>

<script>
  function initRevealObserver() {
    const prefersReducedMotion = window.matchMedia(
      "(prefers-reduced-motion: reduce)"
    ).matches;

    if (prefersReducedMotion) {
      document
        .querySelectorAll(".reveal-heading, .reveal-card")
        .forEach((el) => el.classList.add("is-visible"));
      return;
    }

    const observer = new IntersectionObserver(
      (entries) => {
        for (const entry of entries) {
          if (!entry.isIntersecting) continue;
          entry.target.classList.add("is-visible");
          observer.unobserve(entry.target);
        }
      },
      { threshold: 0.15, rootMargin: "0px 0px -40px 0px" }
    );

    document
      .querySelectorAll(".reveal-heading, .reveal-card")
      .forEach((el) => observer.observe(el));
  }

  // Run on initial load
  initRevealObserver();

  // Re-run after View Transitions (Astro navigation)
  document.addEventListener("astro:after-swap", initRevealObserver);
</script>
